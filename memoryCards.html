<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ËÆ∞ÂøÜÂç°Áâá</title>

<style>
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f5f7fa;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

#tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 16px;
}

#progress {
    padding: 10px 16px;
    font-size: 18px;
    text-align: center;
}

.card {
    flex: 1;
    margin: 20px;
    background: #fff;
    border-radius: 20px;
    border: 4px solid #1565c0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-size: 34px;
    font-weight: 700;
    text-align: center;
    padding: 32px;
    cursor: pointer;
}

.card.back { border-color:#999; }

.group {
    font-size: 16px;
    color: #666;
    margin-bottom: 12px;
}

#buttons {
    display: flex;
    gap: 12px;
    padding: 12px;
}

.btn {
    flex: 1;
    height: 64px;
    border-radius: 16px;
    border: none;
    font-size: 22px;
    font-weight: 700;
    color: #fff;
}

.easy   { background:#43a047 }
.medium { background:#757575 }
.forget { background:#e53935 }
</style>
</head>

<body>

<div id="tags"></div>
<div id="progress">Âä†ËΩΩ‰∏≠‚Ä¶</div>

<div class="card" id="card">
    <div class="group" id="group"></div>
    <div id="content">Âä†ËΩΩ‰∏≠‚Ä¶</div>
</div>

<div id="buttons">
    <button class="btn easy" onclick="mark()">ÁÆÄÂçï</button>
    <button class="btn medium" onclick="mark()">‰∏ÄËà¨</button>
    <button class="btn forget" onclick="mark()">ÂøòËÆ∞</button>
</div>

<script>
const CSV_URL =
  'https://raw.githubusercontent.com/FreyaLLL/memory_cards/refs/heads/main/cards.csv';

let cards = [];
let current = null;
let showBack = false;
let currentTag = 'ALL';
let done = 0;

/* ===== ÁªÑÂç°Áä∂ÊÄÅ ===== */
let groupQueue = [];
let currentGroup = null;

const tagsEl = document.getElementById('tags');
const cardEl = document.getElementById('card');
const contentEl = document.getElementById('content');
const groupEl = document.getElementById('group');
const progressEl = document.getElementById('progress');

/* ===== CSV Ëß£Êûê ===== */
function parseCSV(text) {
    const rows = [];
    let row = [], field = '', inQuotes = false;

    for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i+1];
        if (c === '"' && inQuotes && n === '"') { field += '"'; i++; }
        else if (c === '"') inQuotes = !inQuotes;
        else if (c === ',' && !inQuotes) { row.push(field); field=''; }
        else if ((c === '\n' || c === '\r') && !inQuotes) {
            if (field || row.length) row.push(field);
            if (row.length) rows.push(row);
            row=[]; field='';
        } else field += c;
    }
    if (field || row.length) { row.push(field); rows.push(row); }
    return rows;
}

/* ===== Âä†ËΩΩÊï∞ÊçÆ ===== */
fetch(CSV_URL)
.then(r => r.text())
.then(text => {
    const rows = parseCSV(text).slice(1);
    cards = rows.map(r => {
        const [id, front, back, tag, level, group] = r.map(v => (v||'').trim());
        if (!front || !back) return null;
        return { id, front, back, tag, level:level||'new', group, done:false };
    }).filter(Boolean);

    initTags();
    nextCard();
});

/* ===== tags ===== */
function initTags() {
    tagsEl.innerHTML = '';
    const set = new Set();
    cards.forEach(c => {
        if (c.tag) set.add(c.tag);
        if (c.group) set.add('ÁªÑÂç°');
        if (c.level === 'new') set.add('new');
    });
    addTag('ALL','ÂÖ®ÈÉ®');
    [...set].forEach(t => addTag(t,t));
}

function addTag(val,label){
    const b=document.createElement('button');
    b.textContent=label;
    b.style.cssText=`
      padding:6px 14px;border-radius:14px;border:none;
      font-weight:700;
      background:${val===currentTag?'#1565c0':'#e3f2fd'};
      color:${val===currentTag?'#fff':'#1565c0'};
    `;
    b.onclick=()=>{
        currentTag=val;
        groupQueue=[];
        currentGroup=null;
        initTags();
        nextCard();
    };
    tagsEl.appendChild(b);
}

/* ===== Âç°Áâá ===== */
cardEl.onclick=()=>{
    if(!current) return;
    showBack=!showBack;
    contentEl.textContent=showBack?current.back:current.front;
    cardEl.classList.toggle('back',showBack);
};

function nextCard() {
    /* ===== ÁªÑÂç°Ê®°Âºè ===== */
    if (currentTag === 'ÁªÑÂç°') {
        if (!groupQueue.length) {
            const groups = [...new Set(
                cards.filter(c => !c.done && c.group).map(c => c.group)
            )];
            if (!groups.length) return finish();
            currentGroup = groups[Math.floor(Math.random()*groups.length)];
            groupQueue = cards.filter(c => !c.done && c.group === currentGroup);
        }
        current = groupQueue.shift();
    } 
    /* ===== ÊôÆÈÄöÊ®°Âºè ===== */
    else {
        const pool = cards.filter(c => !c.done &&
            (currentTag==='ALL' ||
             (currentTag==='new' && c.level==='new') ||
             c.tag===currentTag)
        );
        if (!pool.length) return finish();
        current = pool[Math.floor(Math.random()*pool.length)];
    }

    showBack=false;
    cardEl.classList.remove('back');
    contentEl.textContent=current.front;
    groupEl.textContent=current.group?`ÁªÑÔºö${current.group}`:'';
    updateProgress();
}

function mark(){
    if(!current) return;
    current.done=true;
    done++;
    nextCard();
}

function finish(){
    contentEl.textContent='ÂÆåÊàê‰∏ÄËΩÆ üéâ';
    groupEl.textContent='';
    updateProgress();
}

function updateProgress(){
    const left = cards.filter(c=>!c.done).length;
    progressEl.textContent=`Â∑≤ÂÆåÊàê ${done} / ${cards.length} ÔΩú Ââ©‰Ωô ${left}`;
}
</script>

</body>
</html>
